<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Application</title>
    <style>
        .App {
            font-family: sans-serif;
            width: 600px;
            margin: auto;

        }

        .TimeboxCreator {
            text-align: right;
            border: 1px solid gray;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .TimeboxCreator>label>input {
            min-width: 60%;
            margin-left: 20px;
            font-style: 16px;

        }

        button {
            font-style: 16px;


        }

        .Timebox {
            border: 1px solid gray;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
        }

        .TimeboxListElement {
            margin-top: 5px;
            display: flex;
            background-color: #F2BD41;
            color: #1A18A1;
            align-items: center;

        }

        .TimeboxListElementTitle>textarea {
            width: 100%
        }

        .TimeboxListElementTitle {
            width: 80%;
            height: 100%;
            text-align: left;

            margin-right: 5px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
        }

        .TimeboxListElementTime>input[type=number] {
            width: 40px;
        }

        .TimeboxListElementTime {
            width: 155px;
            justify-content: center;
            display: flex;
        }

        .TimeboxListElementTitle textarea,
        .TimeboxListElementTime input {
            border: 0px;
            color: #1A18A1;
        }

        .TimeboxListElementTitle textarea:disabled,
        .TimeboxListElementTime input:disabled {
            border: 0px;
            background-color: #F2BD41;
        }

        .TimeboxListElementAction {
            width: 110px;
            justify-content: center;
            display: flex;
        }

        .Clock {
            color: orangered;
            ;
        }

        .ProgressBar {
            border: 1px solid orange;
            border-radius: 5px;
            height: 25px;
            margin-bottom: 20px;
            padding: 5px;

        }

        .ProgressBar_trackRemaining_true::before {
            width: calc(100% - var(--width));
            float: left;
        }

        .ProgressBar_trackRemaining_false::before {
            width: calc(var(--width));
            float: left;
        }

        .ProgressBar::before {
            background-color: red;
            content: "";
            height: 100%;


        }

        .inactive {
            filter: blur(2px) grayscale(0.4);
        }
    </style>
    <script src="https://unpkg.com/react@17.0.2/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.development.js" crossorigin></script>
    <!-- <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script> -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div id="root"></div>
</body>
<script type="text/babel">

    function Clock({ className, hours = 0, minutes = 0, seconds = 0, miliseconds = 0, keyPreffix }) {
        //hours = (hours < 0 ? 0 : (hours > 23 ? 23 : hours));
        hours = (hours < 0 ? 0 : hours);
        minutes = (minutes < 0 ? 0 : (minutes > 59 ? 59 : minutes));
        seconds = (seconds < 0 ? 0 : (seconds > 59 ? 59 : seconds));
        miliseconds = (miliseconds < 0 ? 0 : (miliseconds > 999 ? 999 : miliseconds));
        return (
            <h2 key='{key}:h2' className={"Clock " + className}>
                Pozostało {String(hours).padStart(2, "0")}:
                {String(minutes).padStart(2, "0")}:
                {String(seconds).padStart(2, "0")}.
                {String(miliseconds).padStart(3, "0")}
            </h2>)
    }
    function ProgressBar({ percent = 0, trackRemaining = false, className }) {

        return (
            <div className={
                `ProgressBar ProgressBar_trackRemaining_${trackRemaining} ${className} `
            }
                style={{ "--width": `${percent}%` }}>

            </div>
        );
    }

    class Timebox extends React.Component {
        constructor(props) {
            super(props);
        }

        render() {

            const {
                timebox, isEditable, isRunning, isPaused, pausesCount, elapsedTimeInMiliSeconds,
                onEdit, onPlay, onStop, onTogglePause } = this.props;

            const totalTimeInMiliSeconds = timebox.totalTimeInMinutes * 60000;
            const timeLeftInMiliSeconds = totalTimeInMiliSeconds - elapsedTimeInMiliSeconds;
            const milisecondsLeft = Math.floor(timeLeftInMiliSeconds % 1000);
            const secondsLeft = Math.floor(timeLeftInMiliSeconds / 1000 % 60);
            const minutesLeft = Math.floor(timeLeftInMiliSeconds / 1000 / 60 % 60);
            const hoursLeft = Math.floor(timeLeftInMiliSeconds / 1000 / 60 / 60);
            const progressInPercent = ((totalTimeInMiliSeconds - elapsedTimeInMiliSeconds) / totalTimeInMiliSeconds) * 100;

            return (<div className={`Timebox  ${isEditable ? "" : "inactive"}`}>

                <h1>{timebox.title}</h1>

                <Clock keyPrefix="clock1" hours={hoursLeft} minutes={minutesLeft} seconds={secondsLeft} miliseconds={milisecondsLeft} className={isPaused ? "inactive" : ""} />
                <ProgressBar percent={progressInPercent} className={isPaused ? "inactive" : ""} trackRemaining="false" />
                <button onClick={onEdit} disabled={isEditable}>Edytuj</button>
                <button onClick={onPlay} disabled={isRunning || isEditable}>Start</button>
                <button onClick={onStop} disabled={!isRunning}>Stop</button>
                <button onClick={onTogglePause} disabled={!isRunning}>{isPaused ? "Wznów" : "Pauzuj"}</button>
                Liczba przerw: {pausesCount}
            </div >);
        }
    }


    class TimeboxCreator extends React.Component {


        render() {
            const { title, totalTimeInMinutes, isEditable,
                onTitleChange,
                onTotalTimeInMinutesChange,
                onAdd
            } = this.props;


            return (<div className={`TimeboxCreator ${isEditable ? "" : "inactive"}`}>
                <label>Co robisz ?<input disabled={!isEditable} value={title} type="text"
                    onChange={onTitleChange} /></label><br />
                <label>Ile minut ?<input disabled={!isEditable} value={totalTimeInMinutes} type="number"
                    onChange={onTotalTimeInMinutesChange} /></label><br />
                <button disabled={!isEditable} onClick={() => {onAdd({title, totalTimeInMinutes})}}>Dodaj</button>
            </div>
            );
        }
    }


    class TimeboxListElement extends React.Component {

        render() {
            console.log("render");
            const { id, isEditable, timebox, onEdit, onDelete, onTitleChange, onTimeChange,onTimeboxUpdate } = this.props;
            return (
                <div className={"Timebox TimeboxListElement"}>
                    <div className="TimeboxListElementTitle"><textarea disabled={!isEditable} value={timebox.title} onChange={ (event) => { onTitleChange(event,id)}} /></div>
                    <div className="TimeboxListElementTime"><input disabled={!isEditable} value={timebox.totalTimeInMinutes} onChange={ (event) => {onTotalTimeInMinutesChange(event,id)}} type="number" />min.</div>
                    <div className="TimeboxListElementAction">
                        <button onClick={onEdit}>{isEditable ? "Zapisz" : "Edutuj"}</button>
                        <button onClick={onDelete}>Usuń</button>
                    </div>
                </div>
            )
        }
    }

    class TimeboxList extends React.Component {


        render() {

            const { timeboxes, onDelete, onEdit, onTitleChange, onTimeChange,onTimeboxUpdate } = this.props;
            return timeboxes.map((elem, key) => {

                //  console.log(elem.isEditable);

                return (
                    <TimeboxListElement
                        key={key}
                        id={key}
                        // title={elem.title}
                        // totalTimeInMinutes={elem.totalTimeInMinutes}
                        timebox={elem}
                        isEditable={elem.isEditable}
                        onTimeboxUpdate={onTimeboxUpdate}
                        onTitleChange={onTitleChange}
                        onTimeChange={onTimeChange}
                        onEdit={() => { onEdit(key) }}
                        onDelete={() => { onDelete(key) }}
                    />
                )
            }
            )
        }
    }

    class Pomodoro extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                title: "Ucze się tego i tamtego?",
                totalTimeInMinutes: 25,
                isEditable: true,

                timebox_lastIntervalTime: 0,
                timebox_isRunning: false,
                timebox_isPaused: false,
                timebox_pausesCount: 0,
                timebox_elapsedTimeInMiliSeconds: 0,

                timeboxes_currentIndex: 0,

                timeboxes: [
                    { title: "Wywołanie eventów", totalTimeInMinutes: 20, isEditable: false },
                    { title: "KP-3034 Migracja z ver 1.14 do 1.15 usuwa powiązanie pacjent pracownik.", totalTimeInMinutes: 20, isEditable: false },
                    { title: "KP-3104 Deploy webserwisu zamówień dla 1.15", totalTimeInMinutes: 20, isEditable: false },
                ]
            }

            this.startTimer = this.startTimer.bind(this);
            this.stopTimer = this.stopTimer.bind(this);
        }

        handleDelete = (key) => {
            this.setState(
                (prevState) => {
                    return { timeboxes: prevState.timeboxes.filter((value, index) => index === key ? false : true) }
                }
            )
        }

        handleTitleChange = (event) => {
            this.setState({
                title: event.target.value
            });
        }

        handleTotalTimeInMinutesChange = (event) => {

            this.setState({
                totalTimeInMinutes: event.target.value
            });
        }
        handleAdd = (timeboxToAdd) => {
            this.setState((prevState) => {
                let timeboxes = prevState.timeboxes;
                timeboxes = [...prevState.timeboxes, timeboxToAdd];
                return ({ timeboxes: timeboxes });
            }
            )
        }
        handleEdit = (event) => {
            this.setState({ isEditable: true });
        }
        handleEditTimeboxListElement = (key) => {


            this.setState((prevState) => {
                let timeboxes = prevState.timeboxes;
                timeboxes[key].isEditable = !prevState.timeboxes[key].isEditable;
                return ({ timeboxes: timeboxes });
            }
            )
        }

        handleTitleElementChange = (event, key) => {
            const { timeboxes } = this.state;
            timeboxes[key].title = event.target.value;

            this.setState({ timeboxes: timeboxes });

        }

        handleTimeElementChange = (event, key) => {
            const { timeboxes } = this.state;
            timeboxes[key].totalTimeInMinutes = event.target.value;

            this.setState({ timeboxes: timeboxes });
        }
        // handleTimeboxUpdate = (indexToUpdate, updatedTimebox) => {
        //     console.log("test");
        //     this.setState((prevState) => {
        //         const { timeboxes } = prevState;
        //         return timeboxes.map((timebox, index) => {
        //             return indexToUpdate === index ? updatedTimebox : timebox;
        //         }

        //         )

        //     })
        // }

        handlePlay = (event) => {
            this.setState(
                {
                    timebox_isRunning: true,
                    timebox_isPaused: false,
                    timebox_elapsedTimeInMiliSeconds: 0
                }
            );
            this.startTimer();
        }

        handleTogglePause = (event) => {
            this.setState(
                (prevState) => {

                    const { timebox_isRunning, timebox_isPaused } = prevState;
                    return {

                        timebox_isPaused: !timebox_isPaused,
                        timebox_pausesCount: !timebox_isPaused ? prevState.timebox_pausesCount + 1 : prevState.timebox_pausesCount
                    }

                },
                () => {
                    const { timebox_isPaused } = this.state;
                    if (timebox_isPaused) {
                        console.log("stop");
                        this.stopTimer();
                    } else {
                        console.log("start");
                        this.startTimer(false);

                    }
                }
            )
        }

        handleStop = (event) => {

            this.setState((prevState) => {


                return
                ({
                    timebox_isRunning: false,
                    timebox_isPaused: false,
                    timebox_pausesCount: 0,
                    timebox_elapsedTimeInMiliSeconds: 0,
                    timebox_lastIntervalTime: 0
                });

            });
            this.stopTimer();
        }

        stopTimer() {
            window.clearInterval(this.intervalId);
            this.setState(
                (prevState) => {
                    const timebox_elapsedTimeInMiliSeconds = prevState.timebox_elapsedTimeInMiliSeconds + new Date().getTime() - prevState.timebox_lastIntervalTime;

                    return ({ timebox_elapsedTimeInMiliSeconds: timebox_elapsedTimeInMiliSeconds });

                }
            );
        }

        startTimer(initializeStartTime = true) {

            this.setState({ timebox_lastIntervalTime: new Date().getTime() });

            this.intervalId = window.setInterval(
                () => {
                    this.setState(
                        (prevState) => {
                            const now = new Date().getTime();
                            const timebox_elapsedTimeInMiliSeconds = prevState.timebox_elapsedTimeInMiliSeconds + new Date().getTime() - prevState.timebox_lastIntervalTime;
                            const timebox_totalTimeInMiliSeconds = prevState.totalTimeInMinutes * 60000;
                            //console.log(timebox_totalTimeInMiliSeconds, timebox_elapsedTimeInMiliSeconds);
                            if (timebox_elapsedTimeInMiliSeconds >= timebox_totalTimeInMiliSeconds) {
                                this.stopTimer();
                            }
                            return ({ timebox_elapsedTimeInMiliSeconds: timebox_elapsedTimeInMiliSeconds, timebox_lastIntervalTime: now });

                        }
                    );
                },
                100
            )
        }


        render() {
            const {
                //TODO adjust names
              
                title,
                totalTimeInMinutes,
                isEditable, //probably to remove

                timebox_isRunning,
                timebox_isPaused,
                timebox_pausesCount,
                timebox_elapsedTimeInMiliSeconds,

                timeboxes_currentIndex,
                timeboxes

            } = this.state;
            return (
                <>
                    <TimeboxCreator title={title}
                        totalTimeInMinutes={totalTimeInMinutes}
                        onTitleChange={this.handleTitleChange}
                        onTotalTimeInMinutesChange={this.handleTotalTimeInMinutesChange}
                        onAdd={this.handleAdd}
                        isEditable={isEditable} />
                    <Timebox
                        timebox={timeboxes[timeboxes_currentIndex]}
                        // title={title}
                        // totalTimeInMinutes={totalTimeInMinutes}

                        isEditable={true}

                        isRunning={timebox_isRunning}
                        isPaused={timebox_isPaused}
                        pausesCount={timebox_pausesCount}
                        elapsedTimeInMiliSeconds={timebox_elapsedTimeInMiliSeconds}

                        onEdit={this.handleEdit}
                        onPlay={this.handlePlay}
                        onStop={this.handleStop}
                        onTogglePause={this.handleTogglePause}

                    />
                    <TimeboxList timeboxes={timeboxes} onDelete={this.handleDelete}
                        onEdit={this.handleEditTimeboxListElement}
                        onTitleChange={this.handleTitleElementChange}
                        onTimeChange={this.handleTimeElementChange}
                       
                    />
                </>
            )
        }
    }
    function App() {
        const totalTimeInSeconds = 3;
        return (<div id="App" className="App">
            <h1>Pomodoro Application</h1>
            <hr />
            <Pomodoro />

        </div>);
    }





    const rootElement = document.getElementById("root");
    ReactDOM.render(<App />
        , rootElement);
</script>

</html>