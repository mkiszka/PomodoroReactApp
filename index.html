<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Application</title>
    <style>
        .App {
            font-family: sans-serif;
        }

        .TimeboxEditor {
            text-align: right;
            border: 1px solid gray;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        input {
            min-width: 60%;
            margin-left: 20px;
            font-style: 16px;

        }

        button {
            font-style: 16px;


        }

        .Timebox {
            border: 1px solid gray;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
        }

        .Clock {
            color: orangered;
            ;
        }

        .ProgressBar {
            border: 1px solid orange;
            border-radius: 5px;
            height: 25px;
            margin-bottom: 20px;
            padding: 5px;

        }

        .ProgressBar_trackRemaining_true::before {
            width: calc(100% - var(--width));
            float: left;
        }

        .ProgressBar_trackRemaining_false::before {
            width: calc(var(--width));
            float: left;
        }

        .ProgressBar::before {
            background-color: red;
            content: "";
            height: 100%;


        }

        .inactive {
            filter: blur(2px) grayscale(0.4);
        }
    </style>
    <script src="https://unpkg.com/react@17.0.2/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div id="root"></div>
</body>
<script type="text/babel">

    function Clock({ className, hours = 0, minutes = 0, seconds = 0, miliseconds = 0, keyPreffix }) {

        //hours = (hours < 0 ? 0 : (hours > 23 ? 23 : hours));
        hours = (hours < 0 ? 0 : hours);
        minutes = (minutes < 0 ? 0 : (minutes > 59 ? 59 : minutes));
        seconds = (seconds < 0 ? 0 : (seconds > 59 ? 59 : seconds));
        miliseconds = (miliseconds < 0 ? 0 : (miliseconds > 999 ? 999 : miliseconds));
        return (
            <h2 key='{key}:h2' className={"Clock " + className}>
                Pozostało {String(hours).padStart(2, "0")}:
                {String(minutes).padStart(2, "0")}:
                {String(seconds).padStart(2, "0")}.
                {String(miliseconds).padStart(3, "0")}
            </h2>)
    }
    function ProgressBar({ percent = 0, trackRemaining = false, className }) {

        return (
            <div className={
                `ProgressBar ProgressBar_trackRemaining_${trackRemaining} ${className} `
            }
                style={{ "--width": `${percent}%` }}>

            </div>
        );
    }

    class Timebox extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                isRunning: false,
                isPaused: false,
                pausesCount: 0,
                elapsedTimeInMiliSeconds: 0,
                startTime: -1
            }

            this.handleStart = this.handleStart.bind(this);
            this.handleStop = this.handleStop.bind(this);
            this.tooglePause = this.tooglePause.bind(this);
        }
        converMinutesToMiliSeconds(value) {
            return value * 60000;
        }
        handleStart(event) {
            this.setState(
                {
                    isRunning: true,
                    elapsedTimeInMiliSeconds: 0
                }
            );
            this.startTimer();
        }
        handleStop(event) {
            this.setState(
                {
                    isRunning: false,
                    isPaused: false,
                    pausesCount: 0,
                    elapsedTimeInMiliSeconds: 0
                }
            );
            this.stopTimer();

        }
        handlePause(event) {
            this.setState(
                {
                    isRunning: false,
                    isPaused: true
                }
            );
        }

        tooglePause() {
            this.setState(
                function (prevState) {
                    const isPaused = !prevState.isPaused;
                    if (isPaused) {
                        this.stopTimer();
                    } else {
                        this.startTimer();
                    }
                    return {
                        isPaused: isPaused,
                        pausesCount: isPaused ? prevState.pausesCount + 1 : prevState.pausesCount
                    }

                }
            )
        }

        stopTimer() {
            window.clearInterval(this.intervalId);
        }

        startTimer() {
            //this.setState({ startTime: new Date().getTime()});
            const startTime = new Date().getTime();
            this.intervalId = window.setInterval(
                () => {
                    this.setState(
                        (prevState) => {

                            const elapsedTimeInMiliSeconds = new Date().getTime() - startTime;
                            const { totalTimeInMinutes } = this.props;
                            const totalTimeInMiliSeconds = this.converMinutesToMiliSeconds(totalTimeInMinutes);
                            console.log(totalTimeInMiliSeconds, elapsedTimeInMiliSeconds);
                            if (elapsedTimeInMiliSeconds >= totalTimeInMiliSeconds) {
                                this.stopTimer();
                            }
                            return ({ elapsedTimeInMiliSeconds: elapsedTimeInMiliSeconds });

                        }
                    );
                },
                100
            )
        }

        render() {

            const { isRunning, isPaused, pausesCount, elapsedTimeInMiliSeconds } = this.state;
            const { title, totalTimeInMinutes, isEditable, onEdit } = this.props;
            const totalTimeInMiliSeconds = this.converMinutesToMiliSeconds(totalTimeInMinutes);

            const timeLeftInMiliSeconds = totalTimeInMiliSeconds - elapsedTimeInMiliSeconds;
            const milisecondsLeft = Math.floor(timeLeftInMiliSeconds % 1000);
            const secondsLeft = Math.floor(timeLeftInMiliSeconds / 1000 % 60);
            const minutesLeft = Math.floor(timeLeftInMiliSeconds / 1000 / 60 % 60);
            const hoursLeft = Math.floor(timeLeftInMiliSeconds / 1000 / 60 / 60);

            const progressInPercent = ((totalTimeInMiliSeconds - elapsedTimeInMiliSeconds) / totalTimeInMiliSeconds) * 100;
            // console.log(elapsedTimeInMiliSeconds, minutesLeft, secondsLeft, milisecondsLeft, progressInPercent);

            return (<div className={`Timebox  ${isEditable ? "inactive" : ""}`}>
                <h1>{title}</h1>

                <Clock keyPrefix="clock1" hours={hoursLeft} minutes={minutesLeft} seconds={secondsLeft} miliseconds={milisecondsLeft} className={isPaused ? "inactive" : ""} />
                <ProgressBar percent={progressInPercent} className={isPaused ? "inactive" : ""} trackRemaining="false" />
                <button onClick={onEdit} disabled={isEditable}>Edytuj</button>
                <button onClick={this.handleStart} disabled={isRunning || isEditable}>Start</button>
                <button onClick={this.handleStop} disabled={!isRunning}>Stop</button>
                <button onClick={this.tooglePause} disabled={!isRunning}>{isPaused ? "Wzów" : "Pauzuj"}</button>
                Liczba przerw: {pausesCount}
            </div >);
        }
    }

    class TimeboxEditor extends React.Component {

        render() {
            const { title, totalTimeInMinutes, isEditable,
                onTitleChange,
                onTotalTimeInMinutesChange,
                onConfirm
            } = this.props;


            return (<div className={`TimeboxEditor  ${isEditable ? "" : "inactive"}`}>
                <label>Co robisz ?<input disabled={!isEditable} value={title} type="text"
                    onChange={onTitleChange} /></label><br />
                <label>Ile minut ?<input disabled={!isEditable} value={totalTimeInMinutes} type="number"
                    onChange={onTotalTimeInMinutesChange} /></label><br />
                <button disabled={!isEditable} onClick={onConfirm}>Zatwierdź zmiany.</button>
            </div>
            );
        }
    }

    class EditableTimeBox extends React.Component {
        state = {
            title: "Ucze się tego i tamtego?",
            totalTimeInMinutes: 25,
            isEditable: true
        }

        handleTitleChange = (event) => {
            this.setState({
                title: event.target.value
            });
        }

        handleTotalTimeInMinutesChange = (event) => {
            this.setState({
                totalTimeInMinutes: event.target.value
            });
        }
        handleConfirm = (event) => {
            this.setState({ isEditable: false });
        }
        handleEdit = (event) => {
            this.setState({ isEditable: true });
        }

        render() {
            const { title, totalTimeInMinutes, isEditable } = this.state;
            return (
                <>
                    <TimeboxEditor title={title}
                        totalTimeInMinutes={totalTimeInMinutes}
                        onTitleChange={this.handleTitleChange}
                        onTotalTimeInMinutesChange={this.handleTotalTimeInMinutesChange}
                        onConfirm={this.handleConfirm}
                        isEditable={isEditable} />
                    <Timebox
                        title={title}
                        totalTimeInMinutes={totalTimeInMinutes}
                        onEdit={this.handleEdit}
                        isEditable={isEditable} />

                </>
            )
        }
    }
    function App() {
        const totalTimeInSeconds = 3;
        return (<div id="App">
            <h1>Pomodoro Application</h1>
            <hr />
            <EditableTimeBox />
        </div>);
    }





    const rootElement = document.getElementById("root");
    ReactDOM.render(<App />
        , rootElement);
</script>

</html>