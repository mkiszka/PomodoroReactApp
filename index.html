<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Application</title>
    <style>
        .App {
            font-family: sans-serif;
            width: 600px;
            margin: auto;

        }

        .TimeboxCreator {
            text-align: right;
            border: 1px solid gray;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .TimeboxCreator>label>input {
            min-width: 60%;
            margin-left: 20px;
            font-style: 16px;

        }

        button {
            font-style: 16px;


        }

        .Timebox {
            border: 1px solid gray;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
        }

        .TimeboxListElement {
            margin-top: 5px;
            display: flex;
            background-color: #F2BD41;
            color: #1A18A1;
            align-items: center;

        }

        .TimeboxListElementTitle>textarea {
            width: 100%
        }

        .TimeboxListElementTitle {
            width: 80%;
            height: 100%;
            text-align: left;

            margin-right: 5px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
        }

        .TimeboxListElementTime>input[type=number] {
            width: 40px;
        }

        .TimeboxListElementTime {
            width: 155px;
            justify-content: center;
            display: flex;
        }

        .TimeboxListElementTitle textarea,
        .TimeboxListElementTime input {
            border: 0px;
            color: #1A18A1;
        }

        .TimeboxListElementTitle textarea:disabled,
        .TimeboxListElementTime input:disabled {
            border: 0px;
            background-color: #F2BD41;
        }

        .TimeboxListElementAction {
            width: 110px;
            justify-content: center;
            display: flex;
        }

        .Clock {
            color: orangered;
            ;
        }

        .ProgressBar {
            border: 1px solid orange;
            border-radius: 5px;
            height: 25px;
            margin-bottom: 20px;
            padding: 5px;

        }

        .ProgressBar_trackRemaining_true::before {
            width: calc(100% - var(--width));
            float: left;
        }

        .ProgressBar_trackRemaining_false::before {
            width: calc(var(--width));
            float: left;
        }

        .ProgressBar::before {
            background-color: red;
            content: "";
            height: 100%;


        }

        .inactive {
            filter: blur(2px) grayscale(0.4);
        }
    </style>
    <script src="https://unpkg.com/react@17.0.2/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.development.js" crossorigin></script>
    <!-- <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script> -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"
        integrity="sha512-UNM1njAgOFUa74Z0bADwAq8gbTcqZC8Ej4xPSzpnh0l6KMevwvkBvbldF9uR++qKeJ+MOZHRjV1HZjoRvjDfNQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <div id="root"></div>
</body>
<script type="text/babel">

    function Clock({ className, hours = 0, minutes = 0, seconds = 0, miliseconds = 0, keyPreffix }) {
        //hours = (hours < 0 ? 0 : (hours > 23 ? 23 : hours));
        hours = (hours < 0 ? 0 : hours);
        minutes = (minutes < 0 ? 0 : (minutes > 59 ? 59 : minutes));
        seconds = (seconds < 0 ? 0 : (seconds > 59 ? 59 : seconds));
        miliseconds = (miliseconds < 0 ? 0 : (miliseconds > 999 ? 999 : miliseconds));
        return (
            <h2 key='{key}:h2' className={"Clock " + className}>
                Pozostało {String(hours).padStart(2, "0")}:
                {String(minutes).padStart(2, "0")}:
                {String(seconds).padStart(2, "0")}.
                {String(miliseconds).padStart(3, "0")}
            </h2>)
    }
    function ProgressBar({ percent = 0, trackRemaining = false, className }) {

        return (
            <div className={
                `ProgressBar ProgressBar_trackRemaining_${trackRemaining} ${className} `
            }
                style={{ "--width": `${percent}%` }}>

            </div>
        );
    }

    class Timebox extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                lastIntervalTime: 0,
                isRunning: false,
                isPaused: false,
                pausesCount: 0,
                elapsedTimeInMiliSeconds: 0,
            }
            this.startTimer = this.startTimer.bind(this);
            this.stopTimer = this.stopTimer.bind(this);
        }
        handlePlay = (event) => {
            this.setState(
                {
                    isRunning: true,
                    isPaused: false,
                    elapsedTimeInMiliSeconds: 0
                }
            );
            this.startTimer();
        }

        handleTogglePause = (event) => {
            this.setState(
                (prevState) => {

                    const { isRunning, isPaused } = prevState;
                    return {

                        isPaused: !isPaused,
                        pausesCount: !isPaused ? prevState.pausesCount + 1 : prevState.pausesCount
                    }

                },
                () => {
                    const { isPaused } = this.state;
                    if (isPaused) {
                        console.log("stop");
                        this.stopTimer();
                    } else {
                        console.log("start");
                        this.startTimer(false);

                    }
                }
            )
        }

        handleStop = (event) => {
            console.log("Stio");
            this.setState((prevState) => {
                return ({
                    isRunning: false,
                    isPaused: false,
                    pausesCount: 0,
                    elapsedTimeInMiliSeconds: 0,
                    lastIntervalTime: 0
                })


            });
            this.stopTimer();
        }

        stopTimer() {
            window.clearInterval(this.intervalId);
            this.setState(
                (prevState) => {
                    const elapsedTimeInMiliSeconds = prevState.elapsedTimeInMiliSeconds + new Date().getTime() - prevState.lastIntervalTime;

                    return ({ elapsedTimeInMiliSeconds: elapsedTimeInMiliSeconds });

                }
            );
        }

        startTimer(initializeStartTime = true) {

            this.setState({ lastIntervalTime: new Date().getTime() });

            this.intervalId = window.setInterval(
                () => {
                    this.setState(
                        (prevState) => {
                            const now = new Date().getTime();
                            const elapsedTimeInMiliSeconds = prevState.elapsedTimeInMiliSeconds + new Date().getTime() - prevState.lastIntervalTime;
                            const totalTimeInMiliSeconds = prevState.totalTimeInMinutes * 60000;
                            //console.log(totalTimeInMiliSeconds, elapsedTimeInMiliSeconds);
                            if (elapsedTimeInMiliSeconds >= totalTimeInMiliSeconds) {
                                this.stopTimer();
                            }
                            return ({ elapsedTimeInMiliSeconds: elapsedTimeInMiliSeconds, lastIntervalTime: now });

                        }
                    );
                },
                100
            )
        }

        render() {

            const {
                timebox, isEditable,
                onPlay, onStop, onTogglePause } = this.props;

            const { isRunning, isPaused, pausesCount, elapsedTimeInMiliSeconds } = this.state

            const totalTimeInMiliSeconds = timebox.totalTimeInMinutes * 60000;
            const timeLeftInMiliSeconds = totalTimeInMiliSeconds - elapsedTimeInMiliSeconds;
            const milisecondsLeft = Math.floor(timeLeftInMiliSeconds % 1000);
            const secondsLeft = Math.floor(timeLeftInMiliSeconds / 1000 % 60);
            const minutesLeft = Math.floor(timeLeftInMiliSeconds / 1000 / 60 % 60);
            const hoursLeft = Math.floor(timeLeftInMiliSeconds / 1000 / 60 / 60);
            const progressInPercent = ((totalTimeInMiliSeconds - elapsedTimeInMiliSeconds) / totalTimeInMiliSeconds) * 100;

            return (<div className={`Timebox  ${isEditable ? "" : "inactive"}`}>
                <h1>{timebox.title}</h1>

                <Clock keyPrefix="clock1"
                    hours={hoursLeft} minutes={minutesLeft}
                    seconds={secondsLeft}
                    miliseconds={milisecondsLeft}
                    className={isPaused ? "inactive" : ""} />
                <ProgressBar
                    percent={progressInPercent} className={isPaused ? "inactive" : ""} trackRemaining="false" />
                <button onClick={this.handlePlay} disabled={isRunning || !isEditable}>Start</button>
                <button onClick={this.handleStop} disabled={!isRunning}>Stop</button>
                <button onClick={this.handleTogglePause} disabled={!isRunning}>{isPaused ? "Wznów" : "Pauzuj"}</button>
                Liczba przerw: {pausesCount}
            </div >);
        }
    }


    class TimeboxCreator extends React.Component {

        constructor(props) {
            super(props);
            this.formRef = React.createRef();
        }

        handleSubmit = (event) => {
            event.preventDefault();
            const { onAdd } = this.props;
            const inputs = event.target.getElementsByTagName("input");
            onAdd({ uid: uuid.v4(), title: inputs[0].value, totalTimeInMinutes: inputs[1].value });
        }

        render() {
            console.log("render TimeboxCreator");

            const { title, totalTimeInMinutes, isEditable,
                onTitleChange,
                onTotalTimeInMinutesChange
            } = this.props;


            return (<form ref={this.form} onSubmit={this.handleSubmit} className={`TimeboxCreator ${isEditable ? "" : "inactive"}`}>
                <label>Co robisz ?<input disabled={!isEditable} value={title} type="text"
                    onChange={onTitleChange} /></label><br />
                <label>Ile minut ?<input disabled={!isEditable} value={totalTimeInMinutes} type="number"
                    onChange={onTotalTimeInMinutesChange} /></label><br />
                <button disabled={!isEditable}>Dodaj</button>
            </form>
            );
        }
    }


    class TimeboxListElement extends React.Component {

        render() {
            console.log("render TimeboxListElement");
            const { index, timebox, onEdit, onDelete, onTitleChange, onTimeChange, onTimeboxUpdate } = this.props;

            return (
                <div className={"Timebox TimeboxListElement"}>
                    <div className="TimeboxListElementTitle"><textarea disabled={!timebox.isEditable} value={timebox.title} onChange={(event) => { onTitleChange(event, index) }} /></div>
                    <div className="TimeboxListElementTime"><input disabled={!timebox.isEditable} value={timebox.totalTimeInMinutes} onChange={(event) => { onTotalTimeInMinutesChange(event, index) }} type="number" />min.</div>
                    <div className="TimeboxListElementAction">
                        <button onClick={onEdit}>{timebox.isEditable ? "Zapisz" : "Edutuj"}</button>
                        <button onClick={onDelete}>Usuń</button>
                    </div>
                </div>
            )
        }
    }

    class TimeboxList extends React.Component {
        //TODO join TimeboxList + TimeboxListElement

        render() {
            console.log("render TimeboxList");
            const { timeboxes, onDelete, onEdit, onTitleChange, onTimeChange, onTimeboxUpdate } = this.props;
            return timeboxes.map((elem, index) => {

                // console.log(elem.uid);

                return (
                    <TimeboxListElement
                        key={elem.uid}
                        index={index}
                        // title={elem.title}
                        // totalTimeInMinutes={elem.totalTimeInMinutes}
                        timebox={elem}
                        onTimeboxUpdate={onTimeboxUpdate}
                        onTitleChange={onTitleChange}
                        onTimeChange={onTimeChange}
                        onEdit={() => { onEdit(elem.uid) }}
                        onDelete={() => { onDelete(elem.uid) }}
                    />
                )
            }
            )
        }
    }

    class Pomodoro extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                title: "Ucze się tego i tamtego?",
                totalTimeInMinutes: 25,
                isEditable: true,             

                timeboxes_currentIndex: 0,

                timeboxes: [
                    { uid: uuid.v4(), title: "Wywołanie eventów", totalTimeInMinutes: 3, isEditable: false },
                    { uid: uuid.v4(), title: "KP-3034 Migracja z ver 1.14 do 1.15 usuwa powiązanie pacjent pracownik.", totalTimeInMinutes: 20, isEditable: false },
                    { uid: uuid.v4(), title: "KP-3104 Deploy webserwisu zamówień dla 1.15", totalTimeInMinutes: 20, isEditable: false },
                ]
            }

          
        }

        handleDelete = (uid) => {
            console.log(uid);
            this.setState(
                (prevState) => {
                    return { timeboxes: prevState.timeboxes.filter((value, index) => value.uid === uid ? false : true) }
                }
            )
        }

        handleTitleChange = (event) => {
            this.setState({
                title: event.target.value
            });
        }

        handleTotalTimeInMinutesChange = (event) => {

            this.setState({
                totalTimeInMinutes: event.target.value
            });
        }
        handleAdd = (timeboxToAdd) => {
            this.setState((prevState) => {
                let timeboxes = prevState.timeboxes;
                timeboxes = [...prevState.timeboxes, timeboxToAdd];
                return ({ timeboxes: timeboxes });
            }
            )
        }

        handleEditTimeboxListElement = (uid) => {

            this.setState((prevState) => {
                return {
                    timeboxes: prevState.timeboxes.map((value) => {
                        return value.uid === uid ? { ...value, isEditable: !value.isEditable } : value
                    })
                }
            }
            )
        }

        handleTitleElementChange = (event, id) => {
            const { timeboxes } = this.state;

            timeboxes[id].title = event.target.value;

            this.setState({ timeboxes: timeboxes });

        }

        handleTimeElementChange = (event, id) => {
            const { timeboxes } = this.state;
            timeboxes[id].totalTimeInMinutes = event.target.value;

            this.setState({ timeboxes: timeboxes });
        }
        // handleTimeboxUpdate = (indexToUpdate, updatedTimebox) => {
        //     console.log("test");
        //     this.setState((prevState) => {
        //         const { timeboxes } = prevState;
        //         return timeboxes.map((timebox, index) => {
        //             return indexToUpdate === index ? updatedTimebox : timebox;
        //         }

        //         )

        //     })
        // }




        render() {
            console.log("render Pomodoro");
            const {
                //TODO adjust names

                title,
                totalTimeInMinutes,
                isEditable, //probably to remove

                timeboxes_currentIndex,
                timeboxes

            } = this.state;
            return (
                <>
                    <TimeboxCreator title={title}
                        totalTimeInMinutes={totalTimeInMinutes}
                        onTitleChange={this.handleTitleChange}
                        onTotalTimeInMinutesChange={this.handleTotalTimeInMinutesChange}
                        onAdd={this.handleAdd}
                        isEditable={isEditable} />
                    <Timebox
                        timebox={timeboxes[timeboxes_currentIndex]}                        
                        isEditable={true}
                    />
                    <TimeboxList timeboxes={timeboxes} onDelete={this.handleDelete}
                        onEdit={this.handleEditTimeboxListElement}
                        onTitleChange={this.handleTitleElementChange}
                        onTimeChange={this.handleTimeElementChange}

                    />
                </>
            )
        }
    }
    function App() {
        const totalTimeInSeconds = 3;
        return (<div id="App" className="App">
            <h1>Pomodoro Application</h1>
            <hr />
            <Pomodoro />

        </div>);
    }





    const rootElement = document.getElementById("root");
    ReactDOM.render(<App />
        , rootElement);
</script>

</html>